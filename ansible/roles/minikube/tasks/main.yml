---
- name: Download minikube
  ansible.builtin.get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: "0755"
    force: true

- name: Ensure kube dir exists for target user
  ansible.builtin.file:
    path: "/home/{{ target_user }}/.kube"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"

- name: Check minikube status
  ansible.builtin.command: minikube status
  become: false
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
  register: mk_status
  failed_when: false
  changed_when: false

- name: Start minikube (docker driver) if not running
  ansible.builtin.command: >
    minikube start --driver=docker --cpus={{ minikube_cpus }} --memory={{ minikube_memory }}mb
  become: false
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
  when: mk_status.rc != 0 or ('Running' not in mk_status.stdout)

- name: Enable metrics-server addon
  ansible.builtin.command: minikube addons enable metrics-server
  become: false
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
  changed_when: false
